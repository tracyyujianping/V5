<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- 1. SEO & GEO Optimization (Hardcoded for Validators) -->
    <title>Copilot Industry 4.0 Network Estimator | Private 5G & Wi-Fi 6 Cost Calculator</title>
    <meta name="description" content="Free tool to estimate the Bill of Materials (BOM) and CAPEX for Industry 4.0 Private Mobile Networks (5G/4G) and Wi-Fi 6. Ideal for smart factories, mines, and warehouses.">
    <meta name="keywords" content="Private 5G Cost Estimator, Industrial Wi-Fi 6 Calculator, Private Network BOM, Small Cell Pricing, All-in-One RAN, Industry 4.0 Connectivity">
    <meta name="author" content="ProNet Team">
    
    <!-- 2. Schema.org JSON-LD (Hardcoded in HEAD for AI/Search Engine Detection) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Copilot Industry 4.0 Network Estimator",
      "applicationCategory": "BusinessApplication",
      "operatingSystem": "Web Browser",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "A professional estimation tool for Private 5G, 4G LTE, and Wi-Fi 6 network deployment costs in industrial environments. Calculates hardware, installation, and service fees.",
      "featureList": [
        "Automatic BOM generation", 
        "Coverage radius calculation based on frequency (700M - 4.9G)", 
        "Indoor vs Outdoor deployment logic",
        "PDF Quote Export",
        "Lead Management"
      ],
      "provider": {
        "@type": "Organization",
        "name": "ProNet Team",
        "email": "MyProNet2025@gmail.com"
      }
    }
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 3. FIREBASE Module Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, onSnapshot, orderBy, setLogLevel, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        try { setLogLevel('error'); } catch (e) {}

        window.FB = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged,
            getFirestore,
            collection,
            addDoc,
            serverTimestamp,
            query,
            onSnapshot,
            orderBy,
            deleteDoc,
            doc
        };
        
        console.log("Firebase modules loaded into window.FB");
    </script>
    
    <style>
        /* Set primary font */
        body { font-family: Calibri, Candara, Segoe, "Segoe UI", Optima, Arial, sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal Overlay Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }

        /* --- Print Styles (Optimized for BOM Only) --- */
        @media print {
            @page { margin: 1cm; size: A4 portrait; }
            body { background-color: #ffffff; color: #000000; font-size: 11pt; height: 100%; width: 100%; }
            .min-h-screen, #root, .main, .grid-container { display: block !important; height: auto !important; width: 100% !important; margin: 0 !important; padding: 0 !important; overflow: visible !important; }
            header, footer, .print-hide, .export-button, .notification-banner, .modal-overlay, .user-info, #input-panel, .seo-section { display: none !important; }
            .summary-card-container, .metrics-grid, .contact-box { display: none !important; }
            #result-panel { box-shadow: none !important; border: none !important; padding: 0 !important; margin: 0 !important; width: 100% !important; max-width: none !important; }
            .print-header-proposal { display: block !important; text-align: center; margin-bottom: 30px; border-bottom: 2px solid #1e3a8a; padding-bottom: 15px; }
            .print-header-proposal h1 { font-size: 22pt; font-weight: bold; color: #1e3a8a; margin: 0; text-transform: uppercase; }
            .print-footer-proposal { display: block !important; position: fixed; bottom: 0; left: 0; right: 0; text-align: center; font-size: 10pt; color: #444; border-top: 1px solid #ccc; padding-top: 10px; }
            table { width: 100% !important; border-collapse: collapse; margin-top: 10px; }
            th { background-color: #f3f4f6 !important; color: #000 !important; border-bottom: 2px solid #000; padding: 10px; text-align: left; font-size: 12pt; }
            td { border-bottom: 1px solid #ddd; padding: 10px; font-size: 11pt; }
            .watermark-container::before { display: none !important; }
            .bg-slate-50, .bg-slate-800, .bg-white { background-color: transparent !important; color: #000 !important; }
            .md\:col-span-7 { width: 100% !important; }
        }
        .print-header-proposal, .print-footer-proposal { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const fmtMoney = (num) => "$" + Math.round(num).toLocaleString();

        const SECRET_CODE = "pro2025"; 

        // Hardcoded User Configuration
        const USER_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDpq-M2tdbMPq1jZMjRmZc_kV2uRr8zYAo",
            authDomain: "g-copilot.firebaseapp.com",
            projectId: "g-copilot",
            storageBucket: "g-copilot.firebasestorage.app",
            messagingSenderId: "248418063508",
            appId: "1:248418063508:web:1aa604e6552a7ad8805081",
            measurementId: "G-NTYFL4KFL4"
        };

        const DB = {
            techMultipliers: { '5G': 1.0, '4G': 0.825 },
            vendors: {
                cost_efficient: { name: "Cost Efficient / Price Priority", multiplier: 1.0, desc: "Optimized for price performance and scalability." },
                tier1: { name: "Tier 1 Supplier / Premium Vendor", multiplier: 1.75, desc: "Provides established solutions from major vendors (1.5x-2x price range)." }
            },
            basePrices: {
                coreNetwork: { name: "Core Network (Lightweight)" }, 
                smallCell: { min: 3900, max: 4100, name: "Small Cell (Indoor RAN, 25dBm)" },
                outdoorUnit: { min: 40000, max: 42000, name: "All-in-One Outdoor RAN (20W)" },
                cabling: { min: 3.5, max: 4.5, name: "Cabling and Accessories (per meter)" },
                serviceRate: 0.15
            },
            coverage: {
                office: { "700M": 125, "2.6G": 33, "3.5G": 25, "4.9G": 18 }, 
                factory: { "700M": 150, "2.6G": 40, "3.5G": 30, "4.9G": 22 }, 
                mine: { "700M": 1100, "2.6G": 295, "3.5G": 220, "4.9G": 156 }
            }
        };
        
        // --- Password Modal ---
        function PasswordModal({ onConfirm, onCancel }) {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                if (password === SECRET_CODE) {
                    onConfirm();
                } else {
                    setError(true);
                    setPassword('');
                }
            };

            return (
                <div className="modal-overlay">
                    <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full p-8 relative animate-fade-in border-t-8 border-red-500">
                        <button onClick={onCancel} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                            <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                        </button>
                        <div className="text-center mb-6">
                            <h3 className="text-2xl font-bold text-slate-800">Password Verification</h3>
                            <p className="text-gray-500 text-sm mt-2">Please enter the password to access saved records.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-gray-700 mb-1">Access Password</label>
                                <input required type="password" className={`w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none ${error ? 'border-red-500' : 'border-gray-300'}`} value={password} onChange={e => { setPassword(e.target.value); setError(false); }} placeholder="Enter Password" />
                                {error && <p className="text-xs text-red-500 mt-1">Incorrect password.</p>}
                            </div>
                            <button type="submit" className="w-full mt-4 bg-red-600 hover:bg-red-700 text-white py-3 rounded-lg font-bold transition-all shadow-lg flex justify-center items-center"><span>Verify and View Leads</span></button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- Leads Viewer ---
        function LeadsViewer({ db, userId, setViewMode, vendors }) {
            const [leads, setLeads] = useState([]);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                if (!db) { setIsLoading(false); return; }

                const appId = 'default-app-id';
                const leadsPath = `artifacts/${appId}/public/data/leads`;
                
                console.log("Attempting to fetch leads from:", leadsPath);

                try {
                    const leadsRef = window.FB.collection(db, leadsPath);
                    const q = window.FB.query(leadsRef, window.FB.orderBy('createdAt', 'desc'));

                    const unsubscribe = window.FB.onSnapshot(q, (snapshot) => {
                        const fetchedLeads = snapshot.docs.map(doc => ({
                            id: doc.id,
                            ...doc.data(),
                            createdAt: doc.data().createdAt ? new Date(doc.data().createdAt.seconds * 1000).toLocaleString('en-US') : 'N/A'
                        }));
                        setLeads(fetchedLeads);
                        setIsLoading(false);
                    }, (error) => {
                        console.error("Error fetching leads: ", error);
                        setIsLoading(false);
                        alert(`Unable to load leads. Error: ${error.message}`);
                    });
                    return () => unsubscribe();
                } catch (e) {
                    console.error("LeadsViewer Logic Error:", e);
                    setIsLoading(false);
                }
            }, [db]);

            // --- Delete Lead Function ---
            const handleDelete = async (leadId, leadName) => {
                if (!confirm(`Are you sure you want to delete the record for "${leadName}"? This cannot be undone.`)) return;
                
                try {
                    const appId = 'default-app-id';
                    const leadsPath = `artifacts/${appId}/public/data/leads`;
                    await window.FB.deleteDoc(window.FB.doc(db, leadsPath, leadId));
                } catch (err) {
                    console.error("Error deleting lead:", err);
                    alert("Failed to delete lead. Please check permissions.");
                }
            };

            // --- Export to Excel Function ---
            const downloadCSV = () => {
                if (!leads || leads.length === 0) {
                    alert("No leads to export.");
                    return;
                }

                const escapeCSV = (str) => {
                    if (str === null || str === undefined) return "";
                    return `"${String(str).replace(/"/g, '""')}"`;
                };
                
                const headers = [
                    "Name", "Company", "Email", "Phone", "Date Saved", 
                    "Location", "Scenario", "Technology", "Vendor", "Deployment", 
                    "Total Area", "Frequency Band", "Services Included", "Est. Min Cost", "Est. Max Cost"
                ];
                
                const rows = leads.map(lead => [
                    lead.name,
                    lead.company,
                    lead.email,
                    lead.phone || "",
                    lead.createdAt,
                    lead.projectParams.location,
                    lead.projectParams.scenario,
                    lead.projectParams.technology,
                    vendors[lead.projectParams.vendor]?.name || lead.projectParams.vendor,
                    lead.projectParams.deployment,
                    lead.projectParams.area + (lead.projectParams.scenario === 'mine' ? ' m' : ' sq m'),
                    lead.projectParams.freq,
                    lead.projectParams.includeServices ? "Yes" : "No",
                    lead.projectResult.grandTotalMin,
                    lead.projectResult.grandTotalMax
                ]);
                
                const csvContent = [
                    headers.map(escapeCSV).join(","),
                    ...rows.map(row => row.map(escapeCSV).join(","))
                ].join("\n");
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", `MyProNet_Leads_Export_${new Date().toISOString().slice(0,10)}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="bg-white p-6 rounded-xl shadow-lg border border-blue-100 min-h-[600px] fade-in w-full max-w-4xl mx-auto">
                    <div className="flex flex-col md:flex-row justify-between items-center mb-8 border-b pb-4 gap-4">
                        <h2 className="text-3xl font-bold text-slate-800">All Saved Quotation Records</h2>
                        <div className="flex gap-2">
                            <button onClick={downloadCSV} className="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg font-bold text-sm transition-colors flex items-center gap-1 shadow-md">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                Export to Excel (CSV)
                            </button>
                            <button onClick={() => setViewMode('estimator')} className="bg-gray-200 hover:bg-gray-300 text-gray-800 py-2 px-4 rounded-lg font-medium text-sm transition-colors flex items-center gap-1">
                                <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                                Return to Estimator
                            </button>
                        </div>
                    </div>
                    {isLoading && <div className="text-center py-12 text-blue-500 font-semibold">Loading data from centralized database...</div>}
                    {!isLoading && leads.length === 0 && <div className="text-center py-12 text-gray-500 border-2 border-dashed border-gray-300 rounded-lg"><p>No saved Leads found in the shared database.</p></div>}
                    {!isLoading && leads.length > 0 && (
                        <div className="space-y-6">
                            {leads.map((lead) => (
                                <div key={lead.id} className="bg-gray-50 p-5 rounded-lg border border-gray-200 shadow-sm relative group">
                                    <button 
                                        onClick={() => handleDelete(lead.id, lead.name)}
                                        className="absolute top-4 right-4 text-red-400 hover:text-red-600 transition-colors p-2 rounded-full hover:bg-red-50"
                                        title="Delete this record"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                    
                                    <div className="flex justify-between items-start mb-4 border-b pb-2 pr-10">
                                        <div className="font-bold text-xl text-blue-600">{lead.name} <span className="text-gray-500 font-normal text-lg">({lead.company})</span></div>
                                        <span className="text-xs text-gray-500 whitespace-nowrap">Saved: {lead.createdAt}</span>
                                    </div>
                                    <div className="grid grid-cols-2 text-sm gap-x-4 gap-y-1 mb-4">
                                        <p><strong>Email:</strong> {lead.email}</p>
                                        <p><strong>Phone:</strong> {lead.phone || 'N/A'}</p>
                                        <p><strong>Company:</strong> {lead.company}</p>
                                    </div>
                                    <h4 className="font-semibold text-base mt-3 mb-2 text-gray-700 border-t pt-3">Project Parameters:</h4>
                                    <div className="grid grid-cols-2 md:grid-cols-4 text-xs gap-x-4 gap-y-2">
                                        <p><strong>Loc:</strong> {lead.projectParams.location}</p>
                                        <p><strong>Tech:</strong> {lead.projectParams.technology}</p>
                                        <p><strong>Vendor:</strong> {vendors[lead.projectParams.vendor]?.name.split(' / ')[0]}</p>
                                        <p><strong>Total Area:</strong> {lead.projectParams.area} {lead.projectParams.scenario === 'mine' ? 'm' : 'sq m'}</p>
                                        <p><strong>Frequency:</strong> {lead.projectParams.freq}</p>
                                        <p><strong>Est. Cost:</strong> {fmtMoney(lead.projectResult.grandTotalMin)} - {fmtMoney(lead.projectResult.grandTotalMax)}</p>
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // --- 4. Lead Modal ---
        function LeadModal({ onClose, onSubmit, isSaving }) {
            const [form, setForm] = useState({ name: '', email: '', company: '', phone: '' });
            const handleSubmit = (e) => { e.preventDefault(); onSubmit(form); };
            return (
                <div className="modal-overlay">
                    <div className="bg-white rounded-xl shadow-2xl max-w-md w-full p-8 relative animate-fade-in">
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                        <div className="text-center mb-6">
                            <h3 className="text-2xl font-bold text-slate-800">Get Your Detailed Quotation</h3>
                            <p className="text-gray-500 text-sm mt-2">Provide details to download PDF.</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Name</label><input required type="text" className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={form.name} onChange={e => setForm({...form, name: e.target.value})} placeholder="John Doe" /></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Email</label><input required type="email" className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={form.email} onChange={e => setForm({...form, email: e.target.value})} placeholder="email@company.com" /></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Company</label><input required type="text" className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={form.company} onChange={e => setForm({...form, company: e.target.value})} placeholder="Company Name" /></div>
                            <div><label className="block text-sm font-bold text-gray-700 mb-1">Phone (Optional)</label><input type="tel" className="w-full p-3 border border-gray-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={form.phone} onChange={e => setForm({...form, phone: e.target.value})} placeholder="Phone" /></div>
                            <button type="submit" disabled={isSaving} className="w-full mt-4 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-lg font-bold shadow-lg flex justify-center items-center">{isSaving ? 'Saving...' : 'Unlock and Download PDF'}</button>
                        </form>
                    </div>
                </div>
            );
        }

        // --- 5. App ---
        function App() {
            const [input, setInput] = useState({ area: 5000, scenario: 'factory', freq: '3.5G', users: 50, vendor: 'cost_efficient', deployment: 'indoor', includeServices: false, location: 'Los Angeles, CA', technology: '5G' });
            const [result, setResult] = useState(null);
            const [showModal, setShowModal] = useState(false);
            const [isSaving, setIsSaving] = useState(false);
            const [viewMode, setViewMode] = useState('estimator'); 
            const [isLeadsPasswordConfirmed, setIsLeadsPasswordConfirmed] = useState(false);
            const [showLeadsPasswordModal, setShowLeadsPasswordModal] = useState(false);
            
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const [userId, setUserId] = useState('Authenticating...'); 
            const [isAuthReady, setIsAuthReady] = useState(false);

            // Handlers defined inside App to be accessible
            const handlePasswordCancel = () => setShowLeadsPasswordModal(false);
            const handlePasswordConfirm = () => { setShowLeadsPasswordModal(false); setIsLeadsPasswordConfirmed(true); setViewMode('viewer'); };

            useEffect(() => {
                if (!window.FB) return;
                
                // Always use the Hardcoded Config for stability in this environment
                const firebaseConfig = USER_FIREBASE_CONFIG;
                // Since we are using hardcoded config, we MUST ignore the environment auth token 
                // to avoid project mismatch errors.
                const initialAuthToken = null; 

                console.log("Starting Firebase Init with config:", firebaseConfig.projectId);

                try {
                    const app = window.FB.initializeApp(firebaseConfig);
                    const firestore = window.FB.getFirestore(app);
                    const authentication = window.FB.getAuth(app);
                    setDb(firestore); 
                    setAuth(authentication); 

                    // Set up auth listener
                    const unsubscribe = window.FB.onAuthStateChanged(authentication, async (user) => {
                        if (user) {
                            console.log("User authenticated:", user.uid);
                            setUserId(user.uid);
                            // Removed wrong state call: setIsFirebaseReady(true)
                        } else {
                            console.log("No user, attempting sign-in...");
                            try {
                                // Only anonymous auth is safe with mismatched tokens
                                await window.FB.signInAnonymously(authentication);
                            } catch (err) { 
                                console.error("Auth Attempt Failed:", err); 
                            }
                        }
                        setIsAuthReady(true); 
                    });
                    return () => unsubscribe();
                } catch (e) { 
                    console.error("Init Critical Error:", e); 
                    setUserId('FIREBASE_ERROR');
                    setIsAuthReady(true);
                }
            }, []);
            
            const handleViewToggle = () => {
                if (viewMode === 'estimator') {
                    if (isLeadsPasswordConfirmed) setViewMode('viewer');
                    else setShowLeadsPasswordModal(true);
                } else setViewMode('estimator');
            };

            const calculate = () => {
                const { area, scenario, freq, users, vendor, deployment, includeServices, technology } = input;
                const radius = DB.coverage[scenario][freq];
                const vendorMultiplier = DB.vendors[vendor].multiplier;
                const techMultiplier = DB.techMultipliers[technology];
                let unitCount = Math.ceil(area / (scenario === 'mine' ? (radius * 2) : (Math.PI * radius * radius * 0.6)));
                unitCount = Math.max(1, unitCount);
                const corePriceMin = users < 500 ? 28000 : 46000;
                const corePriceMax = corePriceMin * 1.05;
                let items = [];
                if (deployment === 'indoor') {
                    items = [{ name: DB.basePrices.coreNetwork.name, min: corePriceMin, max: corePriceMax, count: 1, unit: "Set" }, { ...DB.basePrices.smallCell, count: unitCount, unit: "Unit" }, { ...DB.basePrices.cabling, count: unitCount * 80, unit: "m" }];
                } else {
                    items = [{ name: DB.basePrices.coreNetwork.name, min: corePriceMin, max: corePriceMax, count: 1, unit: "Set" }, { ...DB.basePrices.outdoorUnit, count: unitCount, unit: "Unit" }, { ...DB.basePrices.cabling, count: unitCount * 50, unit: "m" }];
                }
                items = items.map(item => ({ ...item, min: Math.round(item.min * vendorMultiplier * techMultiplier), max: Math.round(item.max * vendorMultiplier * techMultiplier) }));
                let totalMin = 0, totalMax = 0;
                items.forEach(item => { item.subtotalMin = item.min * item.count; item.subtotalMax = item.max * item.count; totalMin += item.subtotalMin; totalMax += item.subtotalMax; });
                let serviceFeeMin = 0, serviceFeeMax = 0;
                if (includeServices) { serviceFeeMin = totalMin * DB.basePrices.serviceRate; serviceFeeMax = totalMax * DB.basePrices.serviceRate; }
                setResult({ items, hardwareMin: totalMin, hardwareMax: totalMax, serviceMin: serviceFeeMin, serviceMax: serviceFeeMax, grandTotalMin: totalMin + serviceFeeMin, grandTotalMax: totalMax + serviceFeeMax, unitName: deployment === 'indoor' ? 'Small Cells' : 'All-In-One RAN Units' });
            };

            useEffect(() => { calculate(); }, [input]);

            const handleLeadSubmit = async (leadData) => {
                setIsSaving(true);
                const appId = 'default-app-id'; // Always use default for consistency across devices
                
                // FIX: Save to PUBLIC path explicitly
                const savePath = `artifacts/${appId}/public/data/leads`;

                if (db) {
                    try {
                        const leadsRef = window.FB.collection(db, savePath);
                        await window.FB.addDoc(leadsRef, { ...leadData, projectParams: input, projectResult: result, createdAt: window.FB.serverTimestamp() });
                        console.log("Lead saved to PUBLIC collection:", savePath);
                    } catch (err) { 
                        console.error("Error saving lead:", err); 
                        alert("Failed to save data. Please check if your internet is connected.");
                    }
                }
                setIsSaving(false);
                setShowModal(false);
                setTimeout(() => window.print(), 500); 
            };
            
            let displayUserId;
            if (userId === 'Authenticating...') displayUserId = 'Authenticating...';
            else if (userId === 'FIREBASE_ERROR') displayUserId = 'Firebase Error';
            else displayUserId = userId;

            const isFirebaseReady = userId !== 'Authenticating...' && userId !== 'FIREBASE_ERROR';
            const statusText = isFirebaseReady ? 'System Ready' : userId;

            return (
                <div className="min-h-screen p-4 md:p-8 max-w-5xl mx-auto watermark-container flex flex-col">
                    <header className="mb-8 flex flex-col items-center justify-center text-center print-hide">
                        <div className="flex flex-col items-center gap-2 mb-2">
                            <div className="mb-2"> 
                                <svg width="60" height="60" viewBox="0 0 100 100" className="drop-shadow-lg transform -rotate-6 hover:rotate-0 transition-transform duration-300">
                                    <defs><filter id="inset-shadow"><feOffset dx="0" dy="2"/><feGaussianBlur stdDeviation="2" result="offset-blur"/><feComposite operator="out" in="SourceGraphic" in2="offset-blur" result="inverse"/><feFlood floodColor="black" floodOpacity="0.2" result="color"/><feComposite operator="in" in="color" in2="inverse" result="shadow"/><feComposite operator="over" in="shadow" in2="SourceGraphic"/></filter></defs>
                                    <rect x="5" y="25" width="90" height="60" rx="4" fill="#E3000B" stroke="#b30000" strokeWidth="2" filter="url(#inset-shadow)" />
                                    <circle cx="25" cy="25" r="12" fill="#E3000B" stroke="#b30000" strokeWidth="1" />
                                    <circle cx="75" cy="25" r="12" fill="#E3000B" stroke="#b30000" strokeWidth="1" />
                                    <text x="50" y="65" textAnchor="middle" fontSize="16" fill="white" fontWeight="bold">ProNet</text>
                                </svg>
                            </div>
                            <h1 className="text-3xl font-extrabold text-slate-800 tracking-tight leading-none">Copilot Industry 4.0</h1>
                            <p className="text-xl font-medium text-gray-500 mt-1">Private Mobile Network Instant Bill of Materials Estimator</p>
                        </div>
                        <div className="user-info text-xs text-gray-400 mt-2 max-w-full overflow-x-auto p-1 border border-gray-200 rounded-lg whitespace-nowrap">
                            Status: <span className={`font-bold ${isFirebaseReady ? 'text-green-600' : 'text-amber-500'}`}>{statusText}</span>
                        </div>
                    </header>
                    
                    <main className="flex-1">
                        {viewMode === 'estimator' && (
                            <div className="grid md:grid-cols-12 gap-6 grid-container fade-in">
                                <div id="input-panel" className="md:col-span-5 bg-white p-6 rounded-xl shadow-lg border border-blue-100 h-fit">
                                    <h2 className="text-xl font-semibold mb-6 flex items-center text-slate-800">
                                        <span className="bg-blue-600 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 shadow-sm">1</span> Project Parameters
                                    </h2>
                                    <div className="space-y-5">
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Project Location</label><input type="text" className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50" value={input.location} onChange={(e) => setInput({...input, location: e.target.value})} placeholder="City, Country" /></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Preferred Technology</label><div className="grid grid-cols-2 gap-2">{['4G', '5G'].map(tech => (<button key={tech} onClick={() => setInput({...input, technology: tech})} className={`py-2 px-1 rounded-lg border text-sm transition-all ${input.technology === tech ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}><div className="font-bold">{tech}</div></button>))}</div><p className="text-xs text-gray-400 mt-1 text-center">Selecting 4G: Hardware cost estimated to decrease by 17.5%.</p></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Deployment Type</label><div className="flex gap-4"><button onClick={() => setInput({...input, deployment: 'indoor'})} className={`flex-1 py-2 px-4 rounded-lg border text-sm transition-all ${input.deployment === 'indoor' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}><span className='font-bold'>Indoor</span></button><button onClick={() => setInput({...input, deployment: 'outdoor'})} className={`flex-1 py-2 px-4 rounded-lg border text-sm transition-all ${input.deployment === 'outdoor' ? 'bg-indigo-600 text-white border-indigo-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}><span className='font-bold'>Outdoor</span></button></div><p className="text-xs text-gray-400 mt-1">Indoor: 25dBm Small Cell. Outdoor: 20W All-in-One RAN.</p></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Equipment Vendor</label><select className="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={input.vendor} onChange={(e) => setInput({...input, vendor: e.target.value})}>{Object.entries(DB.vendors).map(([key, val]) => (<option key={key} value={key}>{val.name}</option>))}</select><p className="text-xs text-blue-600 mt-1">{DB.vendors[input.vendor].desc}</p></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Scenario</label><select className="w-full p-2.5 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={input.scenario} onChange={(e) => setInput({...input, scenario: e.target.value})}><option value="office">Office (High Partition/Loss)</option><option value="factory">Smart Factory (Open Space/Low Loss)</option><option value="mine">Mine/Tunnel (Linear Coverage)</option></select><p className="text-xs text-gray-400 mt-1">Coverage radius adjusts based on expected partition/penetration loss.</p></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">{input.scenario === 'mine' ? 'Total Length (meters)' : 'Total Area (sq meters)'}</label><input type="number" className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-shadow" value={input.area} onChange={(e) => setInput({...input, area: parseInt(e.target.value) || 0})} /></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Frequency Band</label><div className="grid grid-cols-4 gap-2">{['700M', '2.6G', '3.5G', '4.9G'].map(f => (<button key={f} onClick={() => setInput({...input, freq: f})} className={`py-2 px-1 rounded-lg border text-sm transition-all ${input.freq === f ? 'bg-blue-600 text-white border-blue-600 shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:bg-gray-50'}`}><div className="font-bold">{f}</div></button>))}</div><div className="text-xs text-gray-400 mt-1 text-center">Higher frequency provides higher capacity but smaller coverage radius.</div></div>
                                        <div><label className="block text-sm font-bold text-gray-700 mb-2">Estimated Devices/Cameras</label><input type="number" className="w-full p-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={input.users} onChange={(e) => setInput({...input, users: parseInt(e.target.value) || 0})} /><p className="text-xs text-gray-400 mt-1">Device count determines Core Network pricing ($28k or $46k).</p></div>
                                        <div className="flex items-center justify-between py-3 border-t border-gray-200 pt-5"><label htmlFor="service-toggle" className="text-sm font-bold text-gray-700 select-none">Include Services (Design, Installation)</label><div className="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in"><input type="checkbox" id="service-toggle" checked={input.includeServices} onChange={(e) => setInput({...input, includeServices: e.target.checked})} className="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer transition-all duration-200" /><label htmlFor="service-toggle" className="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>
                                    </div>
                                </div>
                                <div id="result-panel" className="md:col-span-7 bg-slate-800 text-white p-6 rounded-xl shadow-lg relative overflow-hidden fade-in flex flex-col">
                                    <div className="print-header-proposal"><h1>Preliminary Proposal Bill of Material (My ProNet)</h1></div>
                                    <div className="absolute top-0 right-0 p-6 opacity-5 pointer-events-none print-hide"><svg width="150" height="150" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg></div>
                                    <h2 className="text-xl font-semibold mb-6 flex items-center z-10 print-hide"><span className="bg-green-500 text-white w-7 h-7 rounded-full flex items-center justify-center text-sm mr-2 shadow-sm">2</span> Bill of Materials (BOM) and Total Cost</h2>
                                    {result && (
                                        <div className="space-y-5 z-10 flex-1 flex flex-col">
                                            <div className="bg-slate-700/80 backdrop-blur-sm p-5 rounded-lg border border-slate-600 shadow-inner summary-card-container print-hide-part">
                                                <div className="summary-card">
                                                    <div className="text-slate-400 text-sm mb-1">Project Summary (Location: {input.location})</div>
                                                    <div className="text-4xl font-bold text-green-400 tracking-tight">{fmtMoney(result.grandTotalMin)} - {fmtMoney(result.grandTotalMax)}</div>
                                                    <div className="flex justify-between items-end mt-2 text-sm"><div className="text-xs text-slate-400">*Includes Hardware{input.includeServices ? ' and Services' : ''}</div><div className="flex gap-2"><div className="bg-blue-600 px-2 py-1 rounded text-white font-bold">{input.technology}</div><div className="bg-slate-600 px-2 py-1 rounded text-white">{DB.vendors[input.vendor].name.split(' / ')[0]}</div></div></div>
                                                </div>
                                            </div>
                                            <div className="overflow-x-auto rounded-lg border border-slate-600">
                                                <table className="w-full text-sm text-left">
                                                    <thead className="text-xs text-slate-300 uppercase bg-slate-900/50"><tr><th className="px-3 py-3">Item</th><th className="px-3 py-3 text-center">Quantity</th><th className="px-3 py-3 text-right">Est. Cost (Minimum)</th></tr></thead>
                                                    <tbody className="divide-y divide-slate-700 bg-slate-800">
                                                        {result.items.map((item, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-700/50 transition-colors"><td className="px-3 py-3 font-medium text-slate-200">{item.name}</td><td className="px-3 py-3 text-center text-blue-300 font-bold whitespace-nowrap">{item.count} <span className="text-xs font-normal text-slate-500">{item.unit}</span></td><td className="px-3 py-3 text-right text-slate-300 font-mono">{fmtMoney(item.subtotalMin)}</td></tr>
                                                        ))}
                                                        <tr className={`transition-opacity ${input.includeServices ? 'bg-slate-700/20 opacity-100' : 'opacity-50'}`}><td className="px-3 py-3 text-slate-400 italic">Services (Design, Install)</td><td className="px-3 py-3 text-center text-slate-500">-</td><td className="px-3 py-3 text-right text-slate-400 font-mono">{input.includeServices ? fmtMoney(result.serviceMin) : "$0 (Not Included)"}</td></tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div className="grid grid-cols-2 gap-3 mt-2 metrics-grid print-hide-part">
                                                <div className="bg-slate-700/40 p-3 rounded-lg text-center border border-slate-600/50"><div className="text-xs text-slate-400 uppercase tracking-wider">Cell Radius (Calculated)</div><div className="font-bold text-lg">{DB.coverage[input.scenario][input.freq]}m</div></div>
                                                <div className="bg-slate-700/40 p-3 rounded-lg text-center border border-slate-600/50"><div className="text-xs text-slate-400 uppercase tracking-wider">Total {result.unitName}</div><div className="font-bold text-lg text-blue-400">{result.items.find(i => i.name.includes(input.deployment === 'indoor' ? 'Small Cell' : 'All-in-One'))?.count || 0}</div></div>
                                            </div>
                                            <div className="print-footer-proposal">Please contact MyProNet2025@gmail.com for detailed proposal and recommended vendors.</div>
                                            <div className="mt-auto pt-4 flex flex-col gap-3 print-hide contact-box">
                                                <button className="export-button w-full bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white py-3 rounded-lg font-bold transition-all shadow-lg hover:shadow-blue-500/30 flex justify-center items-center gap-2" onClick={() => setShowModal(true)}>
                                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Export PDF Quote (Saves Data)
                                                </button>
                                                <div className="bg-slate-900 border-l-4 border-amber-500 p-4 rounded-lg shadow-xl text-center">
                                                    <div className="text-xs font-bold uppercase text-amber-400 mb-1">Detailed Proposal</div>
                                                    <p className="text-sm font-medium text-slate-200">For recommended vendor and detailed technical proposal, please contact:</p>
                                                    <p className="text-lg font-bold text-amber-500 mt-2 break-all" style={{fontFamily: 'Calibri, Candara, Segoe, "Segoe UI", Optima, Arial, sans-serif'}}><a href="mailto:MyProNet2025@gmail.com" className="text-amber-500 hover:text-amber-300 transition-colors underline">MyProNet2025@gmail.com</a></p>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}
                        {viewMode === 'viewer' && <LeadsViewer db={db} userId={userId} setViewMode={handleViewToggle} vendors={DB.vendors} />}
                    </main>
                    <footer className="mt-12 text-center text-gray-400 text-sm pb-8 print-hide">
                        <div className="user-info text-xs text-gray-400 mb-2 max-w-full overflow-x-auto p-1 border border-gray-200 rounded-lg whitespace-nowrap inline-block">Status: <span className={`font-bold ${isFirebaseReady ? 'text-green-600' : 'text-amber-500'}`}>{statusText}</span></div>
                        <p className="mb-1">Â© 2025 ProNet Team | Beta v1.8 | Mode: Deployment (Firebase Ready)</p>
                        <p className="text-xs mt-2 max-w-2xl mx-auto">Disclaimer: This tool provides rough estimates only based on typical industry values. Actual costs depend on site survey, wall materials, and specific vendor negotiations. Transmission line rental and electricity costs are not included.</p>
                        <div className="mt-3"><button onClick={handleViewToggle} className="text-xs text-gray-500 hover:text-gray-700 underline font-medium transition-colors p-1">{viewMode === 'estimator' ? 'View Saved Leads >>' : '<< Return to Estimator'}</button></div>
                    </footer>
                    
                    {/* SEO / FAQ Section (Visible for AI & Users) */}
                    <section className="seo-section mt-12 mb-12 max-w-4xl mx-auto p-6 bg-gray-50 rounded-xl border border-gray-200 print-hide">
                        <h2 className="text-2xl font-bold text-slate-800 mb-6 border-b pb-2">Industry 4.0 Network Planning Insights (FAQ)</h2>
                        <div className="space-y-6">
                            <div>
                                <h3 className="text-lg font-semibold text-blue-700 mb-2">How much does a Private 5G network cost for a smart factory?</h3>
                                <p className="text-gray-600 text-sm">
                                    The cost of a Private 5G network varies significantly based on coverage area, device density, and deployment type. 
                                    Our <strong>Private 5G Cost Estimator</strong> calculates this by analyzing your specific square footage (e.g., 50,000 sq m) and device count. 
                                    Generally, a basic setup starts with a Core Network license (approx. $28k-$46k depending on capacity) plus Radio Access Network (RAN) hardware. 
                                    Indoor Small Cells typically range from $3,900 per unit, while high-power Outdoor All-in-One units can cost around $40,000.
                                </p>
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold text-blue-700 mb-2">What is the difference between Indoor Small Cells and Outdoor All-in-One RAN?</h3>
                                <p className="text-gray-600 text-sm">
                                    <strong>Indoor Small Cells</strong> (25dBm output) are designed for high-density environments like offices and factory floors with many obstructions (walls, machinery). 
                                    They have a smaller coverage radius (approx. 25-50m depending on frequency) but provide high capacity. 
                                    <strong>Outdoor All-in-One RAN</strong> units (20W output) are powerful base stations designed for wide-area coverage such as mines, tunnels, or large campus exteriors, 
                                    offering a coverage radius of up to 1.1km in open spaces at 700MHz.
                                </p>
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold text-blue-700 mb-2">Is Wi-Fi 6 or Private 5G better for Industry 4.0?</h3>
                                <p className="text-gray-600 text-sm">
                                    Both technologies have their place. <strong>Private 5G</strong> offers superior reliability, ultra-low latency (URLLC), and seamless mobility for moving robots (AGVs/AMRs), 
                                    making it ideal for mission-critical industrial control. <strong>Wi-Fi 6</strong> is cost-effective for static IT assets and general connectivity but may struggle with 
                                    interference and handovers in complex metal-rich factory environments. This tool helps you compare the Bill of Materials (BOM) for cellular-based private networks (4G/5G).
                                </p>
                            </div>
                            <div>
                                <h3 className="text-lg font-semibold text-blue-700 mb-2">How does frequency band affect network planning (700MHz vs 4.9GHz)?</h3>
                                <p className="text-gray-600 text-sm">
                                    Frequency is a trade-off between coverage and capacity. <strong>Low-band (700MHz)</strong> offers excellent penetration and wide coverage (ideal for mines/tunnels), 
                                    requiring fewer base stations to cover a large area. <strong>Mid-to-High band (3.5GHz, 4.9GHz)</strong> offers massive bandwidth capacity for HD video and massive IoT 
                                    but has a shorter range and poorer wall penetration, requiring a denser grid of Small Cells. Our calculator automatically adjusts the cell radius based on your selected frequency.
                                </p>
                            </div>
                        </div>
                    </section>

                    {showModal && <LeadModal onClose={() => setShowModal(false)} onSubmit={handleLeadSubmit} isSaving={isSaving} />}
                    {showLeadsPasswordModal && <PasswordModal onConfirm={handlePasswordConfirm} onCancel={handlePasswordCancel} />}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>